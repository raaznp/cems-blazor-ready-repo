@page "/admin/participants"
@attribute [Authorize(Policy = "AdminOnly")]
@rendermode RenderMode.InteractiveServer

@inject ParticipantService ParticipantService

@if (!string.IsNullOrWhiteSpace(_message))
{
    <div class="alert @(_isError ? "alert-danger" : "alert-success")">@_message</div>
}

<div class="d-flex flex-column gap-3">
    <!-- ADD / EDIT PARTICIPANT -->
    <div class="card border-success">
        <div class="card-body">
            <h5>@(_editing ? "Edit Participant" : "Add Participant")</h5>

            <EditForm Model="_model" OnValidSubmit="Save" FormName="ParticipantAdminForm">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-2">
                    <label class="form-label">Name</label>
                    <InputText class="form-control" @bind-Value="_model.FullName" />
                </div>

                <div class="mb-2">
                    <label class="form-label">Date of Birth</label>
                    <InputDate class="form-control" @bind-Value="_dobTemp" />
                </div>

                <div class="mb-2">
                    <label class="form-label">Phone Number</label>
                    <InputText class="form-control" @bind-Value="_model.PhoneNumber" />
                </div>

                <div class="mb-2">
                    <label class="form-label">Email</label>
                    <InputText class="form-control" @bind-Value="_model.Email" />
                </div>





                <button class="btn btn-admin me-2" type="submit">OK</button>
                <button type="button" class="btn btn-admin" @onclick="Reset">CLear</button>
            </EditForm>
        </div>
    </div>

    <!-- PARTICIPANTS LIST BELOW FORM -->
    <div class="card border-success">
        <div class="card-body">
            <h5>Participant's Details:'</h5>

            @if (_items is null)
            {
                <p>Loading...</p>
            }
            else
            {
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>DOB</th>
                            <th>Phone</th>
                            <th>Email</th>
                            
                            
                            <th style="width:160px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in _items)
                        {
                            <tr>
                                <td>@p.FullName</td>
                                <td>@p.DateOfBirth</td>
                                <td>@p.PhoneNumber</td>
                                <td>@p.Email</td>
                                
                                
                                <td>
                                    <button class="btn btn-admin btn-sm me-1" @onclick="() => Edit(p.Id)">Edit</button>
                                    <button class="btn btn-admin btn-sm btn-danger" @onclick="() => Delete(p.Id)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

            }
        </div>
    </div>
</div>

@code {
    private List<Participant>? _items;

    private Participant _model = new();
    private DateTime _dobTemp = new DateTime(2025, 1, 1);//yyyy,dd,mm

    private bool _editing;
    private string _message = "";
    private bool _isError = false;

    protected override async Task OnInitializedAsync()
    {
        await Reload();
        Reset();
    }

    private async Task Reload()
    {
        _items = await ParticipantService.GetAllAsync();
    }

    private async Task Save()
    {
        try
        {
            _message = "";
            _isError = false;

            // Copy DOB into model (Participant.DateOfBirth is DateOnly)
            _model.DateOfBirth = DateOnly.FromDateTime(_dobTemp.Date);

            if (_editing)
            {
                await ParticipantService.UpdateAsync(_model);
            }
            else
            {
                await ParticipantService.AddAsync(_model);
            }

            _message = "Saved successfully.";
            Reset();
            await Reload();
        }
        catch (Exception ex)
        {
            _message = ex.Message;
            _isError = true;
        }
    }

    private async Task Edit(int id)
    {
        _message = "";
        _isError = false;

        var p = await ParticipantService.GetByIdAsync(id);
        if (p is null) return;

        _model = new Participant
        {
            Id = p.Id,
            FullName = p.FullName,
            Email = p.Email,
            PhoneNumber = p.PhoneNumber,
            DateOfBirth = p.DateOfBirth
        };

        _dobTemp = new DateTime(p.DateOfBirth.Year, p.DateOfBirth.Month, p.DateOfBirth.Day);
        _editing = true;
    }

    private async Task Delete(int id)
    {
        try
        {
            _message = "";
            _isError = false;

            var ok = await ParticipantService.DeleteAsync(id);
            _message = ok ? "Participant Deleted successfully." : "Can not Delete! Participant has Registration.";
            await Reload();
        }
        catch (Exception ex)
        {
            _message = ex.Message;
            _isError = true;
        }
    }

    private void Reset()
    {
        _model = new Participant();
        _dobTemp = new DateTime(2025, 1, 1);
        _editing = false;
    }
}
