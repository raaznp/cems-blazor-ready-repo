@page "/admin/activities"
@attribute [Authorize(Policy = "AdminOnly")]
@inject ActivityService ActivityService

@if (!string.IsNullOrWhiteSpace(_message))
{
    <div class="alert alert-info">@_message</div>
}

<div class="row g-3">

    <!-- ADD / EDIT ACTIVITY -->
    <div class="col-12">
        <div class="card border-success">
            <div class="card-body">
                <h5>@(_editing ? "Edit Activity" : "Add Activity")</h5>

                <EditForm Model="_model" OnValidSubmit="Save">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-2">
                        <label class="form-label">Activity Name</label>
                        <InputText class="form-control" @bind-Value="_model.Name" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Description</label>
                        <InputTextArea class="form-control" @bind-Value="_model.Description" />
                    </div>

                    <button class="btn btn-success me-2">
                        @(_editing ? "Update" : "OK")
                    </button>

                    <button type="button" class="btn btn-secondary" @onclick="Reset">
                        Clear
                    </button>
                </EditForm>
            </div>
        </div>
    </div>

    <!-- ACTIVITY LIST -->
    <div class="col-12">
        <div class="card border-success">
            <div class="card-body">
                <h5>Activities List</h5>

                @if (_items is null)
                {
                    <p>Loading...</p>
                }
                else if (!_items.Any())
                {
                    <p class="text-muted">No activities found.</p>
                }
                else
                {
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th style="width:160px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var a in _items)
                            {
                                <tr>
                                    <td>@a.Name</td>
                                    <td>@a.Description</td>
                                    <td>
                                        <button class="btn btn-outline-success btn-sm me-1"
                                                @onclick="() => Edit(a.Id)">
                                            Edit
                                        </button>

                                        <button class="btn btn-outline-danger btn-sm"
                                                @onclick="() => Delete(a.Id)">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>

</div>

@code {

    private List<Activity>? _items;
    private Activity _model = new();
    private bool _editing = false;
    private string _message = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _items = await ActivityService.GetAllAsync();
    }

    private async Task Save()
    {
        try
        {
            _message = "";

            if (_editing)
                await ActivityService.UpdateAsync(_model);
            else
                await ActivityService.AddAsync(_model);

            _message = "Saved successfully.";
            Reset();
            await LoadData();
        }
        catch (Exception ex)
        {
            _message = ex.Message;
        }
    }

    private async Task Edit(int id)
    {
        var item = await ActivityService.GetByIdAsync(id);
        if (item == null) return;

        _model = new Activity
        {
            Id = item.Id,
            Name = item.Name,
            Description = item.Description
        };

        _editing = true;
    }

    private async Task Delete(int id)
    {
        try
        {
            var success = await ActivityService.DeleteAsync(id);
            _message = success
                ? "Activity deleted successfully."
                : "This activity is in use and cannot be deleted.";

            await LoadData();
        }
        catch (Exception ex)
        {
            _message = ex.Message;
        }
    }

    private void Reset()
    {
        _model = new Activity();
        _editing = false;
    }
}
